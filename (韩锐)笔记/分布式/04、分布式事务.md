互联网的业务特点，数据量较大，并发量较大，经常使用拆库的方式提升系统的性能。如果进行了拆库，余额、订单、流水可能分布在不同的数据库上，甚至不同的数据库实例上，此时就需要分布式事务了。网络上有很多对分布式事务的讨论，面试的时候分布式事务也是热门考点，我在此做一个汇总。

### 1. 名词解释

很多名词一直有所耳闻，但未曾深究，在此一一记录。

- **补偿事务**：事务的每个参与方都需要提供一个补偿的操作，当（多个）事务中有任意一个失败时，所有已成功提交的事务需要按顺序去执行各自的补偿事务，将系统回滚到之前的状态。

  ```java
  // 执行第一个事务
  int flag = do_transfer();
  if(flag == true){
      //第一个事务成功，则执行第二个事务
      flag= do_orderT();
      if(flag == true){
          // 第二个事务成功，则成功
          return true;
      } else{
          // 第二个事务失败，执行第一个事务的补偿事务
          compensate_transfer();
      }
  }
   
  ```

  如上述代码所示，当第二个事务失败时，手动撤销（补偿）第一个事务。

- **后置提交**：多个事务在最后时刻一起提交

  ```java
  trx1.exec(); trx2.exec(); trx3.exec();
  trx1.commit(); trx2.commit(); trx3.commit();
  ```

  这种方式虽然不能彻底解决多库分布式事务数据一致性问题，但能大大降低数据不一致的概率，牺牲的是吞吐量，事务执行的时间过长。

- **柔性事物**：柔性事物是相对于符合ACID的刚性事务来说的，根据CAP定理，分布式环境下无法做到像刚性事务那样，所以对一致性做出了妥协，也就是只需做到最终一致性。像这种满足BASE（基本可用，软状态，最终一致性）的分布式事务就叫称为柔性事务。

- **TCC**：全称Try-Confirm-Cancel，是柔性事物的一种常见的实现方式。Try阶段尝试执行，比如资源预留、锁定；Confirm阶段仅使用Try阶段预留的资源；Cancel阶段针对有事务提交失败的情况，此时已提交的事务需要取消资源的预留和锁定。

### 2. 柔性事物

https://juejin.im/post/5aa8b8636fb9a028c67567c6





https://mp.weixin.qq.com/s?__biz=MzA5OTAyNzQ2OA==&mid=2649709335&idx=1&sn=9024c5ac663b9dc11c3886fb8bbe962e&chksm=88936474bfe4ed623a2f541e072c8e7ca3837a508bf5799ae39ae1a5b9e43d881af78f6bbc8f&mpshare=1&scene=23&srcid=0710iWvQuaNjb6fmS5iEx4yU&sharer_sharetime=1594338758765&sharer_shareid=8b6cce4aa7804cb52b9e5a9c08be2cf4%23rd