### 计算机体系结构

内存管理目标：

1. 抽象：逻辑地址空间
2. 保护：独立地址空间
3. 共享：访问相同内存
4. 虚拟化：更多的地址空间



### 地址空间

##### 1. 地址空间分类

1. 逻辑空间：一个运行的程序所拥有的内存范围
2. 物理地址空间：硬件支持的地址空间



##### 2.逻辑地址生成

xxx



##### 3.逻辑地址空间如何映射到物理地址空间？



### 连续内存分配

##### 1. 连续内存分配特点

- 分配给程序的物理内存必须是连续的
- 存在外碎片和内碎片
- 内存分配的动态修改困难
- 内存利用率较低

##### 2. 连续内存分配策略

1. 首次适配
2. 最佳适配
3. 最差适配



##### 3. 压缩式与交换式碎片整理

- 压缩式内存整理：移动应用程序位置，将内存压缩到一起，可能开销很大而且不太安全
- 交换式碎片整理：充分利用硬盘，将空闲（等待）中的应用内存交换到硬盘，临时释放出内存，这种方式的开销也可能会比较大



### 非连续内存分配

非连续内存分配的优点：

- 允许一个程序的使用非连续的物理地址空间
- 允许共享代码和数据
- 支持动态加载和动态链接



非连续内存分配主要的问题是如何建立虚拟地址和物理地址之间的转换。这种转换可以通过软件和硬件实现，而基于软件的实现方式虽然非常灵活，但开销非常大，当前主流的是通过结合硬件的方案。



基于硬件的实现方案，根据如何选择非连续分配中的内存分块大小，划分成2种类型：

1. 段式存储管理（Segmentation）
2. 页式存储管理（Paging）



##### 段式存储管理

分段指的是将应用程序内存划分成多个段，如将程序分成：数据、堆、栈、库等，不同的部分划分到不同的内存块中。



##### 页式存储管理

与分段的最大区别是：分段的大小是可变的，而分页的大小是固定的，通常是2的幂。



页式存储管理有以下概念：

- 页帧（帧、物理页面，Frame，Page Frame）
  - 把物理地址空间划分为大小相同的基本分配单位
  - 2的n次幂
- 页面（页、逻辑页面、Page）
  - 把逻辑地址空间也划分为相同的基本分配单位
  - 帧和页的大小必须是相同的
- 页面到页帧
  - 逻辑地址到物理地址的转换
  - 页表
  - MMU/TLB



物理地址用二元组`(f, o)`表示，计算公式：
$$
addr=f*2^S+o
$$
其中，`2^S`表示每帧的字节数，`f`是帧号（第几帧），`o`是帧内偏移量。逻辑地址用`(p, o)`表示，其中`p`表示页号，计算公式与物理地址计算一致。



在应用程序执行时，CPU会从页表（Page Table）中查找逻辑地址对应的物理地址，页表是一个数组，保存了页号和帧号的映射关系。

页表项组成：

- 存在位（resident bit）：表示是否有物理帧与之对应
- 修改位（dirty bit）：表示页面内容是否修改
- 引用位（clock/reference bit）：表示是否访问过相应存储单元



页式存储管理允许分配不连续的存储空间，但也会带来很多问题，包括：

1. 性能问题
   - 访问一个内存单元需要2次内存访问（先查页表，再访问数据）
2. 页表大小问题
   - 页表可能很大，64位机器如果每页1024字节，那么页表会非常大

为了应对这些问题，解决方案包括：

- 缓存（Caching）：将最近访问的页表项缓存起来
- 间接（Indirection）访问：将页表分为多级页表提升性能



快表（Translation Loo-aside Buffer，TLB）

TLB主要用于缓存近期访问的页表项



##### 参考

1. [CentOS 7 关闭透明大页](https://www.yanning.wang/archives/780.html)

